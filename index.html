<!DOCTYPE html> <html lang="th"> <head>     <meta charset="UTF-8">     <meta name="viewport" content="width=device-width, initial-scale=1.0">     <title>ระบบจำลองคำนวณภาษีและค่าลดหย่อน</title>     <!-- Load Tailwind CSS -->     <script src="https://cdn.tailwindcss.com"></script>     <!-- Load Lucide Icons -->     <script src="https://unpkg.com/lucide@latest"></script>     <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+Thai:wght@100..900&display=swap" rel="stylesheet">     <style>         /* กำหนด Font หลักให้เป็น Noto Sans Thai และ fallback เป็น Inter/Sans-serif */         body {             font-family: 'Noto Sans Thai', 'Inter', sans-serif;             background-color: #f7f9fb;         }         .scroll-smooth {              scroll-behavior: smooth;         }         /* Style for the fixed bottom-right button to prevent overlap */         .main-content-padding {             padding-bottom: 100px; /* Ensure space for the fixed 'Next' button */         }         /* Custom scrollbar for better aesthetics */         ::-webkit-scrollbar {             width: 8px;         }         ::-webkit-scrollbar-track {             background: #f1f1f1;         }         ::-webkit-scrollbar-thumb {             background: #cbd5e1;             border-radius: 4px;         }         ::-webkit-scrollbar-thumb:hover {             background: #94a3b8;         }     </style> </head> <body class="min-h-screen">      <div id="app" class="relative min-h-screen flex">                  <!-- Sidebar Navigation -->         <aside id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out z-30 bg-white border-r border-gray-200 w-64 p-4 shadow-xl md:shadow-none">             <!-- Sidebar Content will be rendered here -->         </aside>          <!-- Main Content Area -->         <div class="flex-1 md:ml-64 transition-all duration-300">             <!-- Header/Top Nav -->             <header class="sticky top-0 bg-white border-b border-gray-200 z-20 shadow-sm">                 <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">                     <h1 class="text-xl font-bold text-gray-900 flex items-center gap-2">                         <span class="md:hidden cursor-pointer" onclick="toggleSidebar()">                             <svg data-lucide="menu" width="24" height="24" class="text-gray-600"></svg>                         </span>                         <svg data-lucide="calculator" width="24" height="24" class="text-blue-600"></svg>                         <span>TAX SIMULATOR</span>                     </h1>                     <div class="flex items-center gap-4">                         <button class="text-sm font-medium text-gray-700 hover:text-blue-600 transition-colors hidden sm:block">                             <svg data-lucide="user" width="20" height="20" class="inline-block mr-1"></svg>                             ผู้ใช้งาน                         </button>                         <button class="text-sm font-medium text-gray-700 hover:text-blue-600 transition-colors hidden sm:block">                             <svg data-lucide="book-open" width="20" height="20" class="inline-block mr-1"></svg>                             คู่มือ                         </button>                     </div>                 </div>             </header>              <!-- Page Content -->             <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8 main-content-padding scroll-smooth">                 <div id="page-content">                     <!-- Dynamic content (Income, Deduction, Dashboard, Advisor) will be injected here -->                 </div>             </main>              <!-- Next Button for Forms -->             <div id="next-button-container" class="absolute bottom-8 right-6 md:right-12 z-10 hidden">                  <button                     onclick="nextTab()"                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-2 font-medium transition-all transform hover:scale-105 active:scale-95"                  >                    ถัดไป <svg data-lucide="chevron-down" width="18" height="18" class="rotate-[-90deg]"></svg>                  </button>             </div>                      </div>                  <!-- Sidebar Backdrop (for mobile) -->         <div id="sidebar-backdrop" class="fixed inset-0 bg-black opacity-0 md:opacity-0 transition-opacity duration-300 ease-in-out z-20 hidden md:hidden" onclick="toggleSidebar()"></div>      </div>      <!-- Modal Container -->     <div id="modal-container">         <!-- Modal content will be injected here -->     </div>      <script>         // Global variables and constants for the application          // --- Constants & Data --         const INCOME_TYPES = [             { id: '40(1)', name: '40(1) เงินเดือน/โบนัส', desc: 'เงินเดือน ค่าจ้าง โบนัส บำนาญ', deductionDesc: '50% ไม่เกิน 100,000', defaultRate: 0.5, hasFixedCap: true },             { id: '40(2)', name: '40(2) รับทำงานให้', desc: 'ค่านายหน้า ค่าคอมมิชชั่น ค่ารับเหมาแรงงาน', deductionDesc: '50% ไม่เกิน 100,000 (รวมกับ 40(1))', defaultRate: 0.5, hasFixedCap: true },             { id: '40(3)', name: '40(3) ค่าลิขสิทธิ์', desc: 'ค่าลิขสิทธิ์ ค่าGoodwill', deductionDesc: '50% ไม่เกิน 100,000 หรือตามจริง', defaultRate: 0.5, hasFixedCap: true },             { id: '40(4)', name: '40(4) ดอกเบี้ย/เงินปันผล', desc: 'ดอกเบี้ย เงินปันผล ส่วนแบ่งกำไร', deductionDesc: 'หักค่าใช้จ่ายไม่ได้ (หรือเลือกหักภาษี ณ ที่จ่าย 10% - 15%)', defaultRate: 0, hasFixedCap: false },             { id: '40(5)', name: '40(5) ค่าเช่า', desc: 'ค่าเช่าทรัพย์สิน ค่าผิดสัญญาเช่า', deductionDesc: '10% - 40% (ขึ้นอยู่กับประเภททรัพย์สิน)', defaultRate: 0.3, hasFixedCap: false },             { id: '40(6)', name: '40(6) วิชาชีพ', desc: 'แพทย์, นักกฎหมาย, วิศวกร, สถาปนิก, บัญชี, ศิลปิน', deductionDesc: '60% (ยกเว้นแพทย์ 60% หรือ 40%)', defaultRate: 0.6, hasFixedCap: false },             { id: '40(7)', name: '40(7) รับเหมาเบ็ดเสร็จ', desc: 'รับเหมาที่ผู้รับเหมาจัดหาสัมภาระด้วย', deductionDesc: '70% หรือตามจริง', defaultRate: 0.7, hasFixedCap: false },             { id: '40(8)', name: '40(8) ธุรกิจ/อื่นๆ', desc: 'ค้าขาย ธุรกิจ บริการอื่นๆ ที่ไม่เข้าพวก 40(1)-(7)', deductionDesc: '60% หรือตามจริง', defaultRate: 0.6, hasFixedCap: false },         ];          const DEDUCTION_TYPES = [             // กลุ่มค่าลดหย่อนส่วนตัวและครอบครัว (Personal & Family)             { id: 'personal', name: 'ค่าลดหย่อนส่วนตัว', desc: '60,000 บาท', type: 'family', max: 60000, icon: 'user' },             { id: 'spouse', name: 'คู่สมรสไม่มีรายได้', desc: '60,000 บาท', type: 'family', max: 60000, icon: 'users' },             { id: 'child', name: 'บุตร', desc: '30,000 บาท/คน (บุตรคนที่ 2 ขึ้นไปที่เกิดตั้งแต่ปี 2561 เป็นต้นไป ลดได้ 60,000 บาท)', type: 'family', max: Infinity, icon: 'user' },             { id: 'parent', name: 'บิดามารดา', desc: '30,000 บาท/คน (เงื่อนไข: อายุ 60 ปีขึ้นไป มีรายได้ไม่เกิน 30,000 บาท)', type: 'family', max: Infinity, icon: 'home' },             // กลุ่มประกันและการลงทุน (Insurance & Investment)             { id: 'life_insurance', name: 'เบี้ยประกันชีวิต', desc: 'สูงสุด 100,000 บาท', type: 'insurance', max: 100000, icon: 'heart-pulse' },             { id: 'health_insurance', name: 'เบี้ยประกันสุขภาพ', desc: 'สูงสุด 25,000 บาท (รวมประกันชีวิตไม่เกิน 100,000 บาท)', type: 'insurance', max: 25000, icon: 'activity' },             { id: 'parent_health_insurance', name: 'เบี้ยประกันสุขภาพบิดามารดา', desc: 'สูงสุด 15,000 บาท', type: 'insurance', max: 15000, icon: 'heart-pulse' },             { id: 'pension_fund', name: 'กองทุนบำเหน็จบำนาญ (RMF/SSF/PVD)', desc: 'รวมกันไม่เกิน 500,000 บาท และไม่เกิน 30% ของเงินได้', type: 'investment', max: 500000, icon: 'trending-up' },             { id: 'social_security', name: 'ประกันสังคม', desc: 'ตามจ่ายจริง (ปัจจุบันสูงสุด 9,000 บาท)', type: 'insurance', max: 9000, icon: 'shield-check' },             // กลุ่มอสังหาริมทรัพย์และอื่นๆ (Property & Other)             { id: 'home_loan_interest', name: 'ดอกเบี้ยกู้ยืมเพื่อที่อยู่อาศัย', desc: 'สูงสุด 100,000 บาท', type: 'property', max: 100000, icon: 'home' },             { id: 'donation', name: 'บริจาคทั่วไป', desc: 'ไม่เกิน 10% ของเงินได้หลังหักค่าใช้จ่ายและค่าลดหย่อนอื่นๆ', type: 'other', max: Infinity, icon: 'gift' },         ];          const TAX_BRACKETS = [             { max: 150000, rate: 0.00, tax: 0 },             { max: 300000, rate: 0.05, tax: 7500 },             { max: 500000, rate: 0.10, tax: 20000 },             { max: 750000, rate: 0.15, tax: 37500 },             { max: 1000000, rate: 0.20, tax: 50000 },             { max: 2000000, rate: 0.25, tax: 250000 },             { max: 5000000, rate: 0.30, tax: 900000 },             { max: Infinity, rate: 0.35, tax: Infinity } // Infinity max means 'over' 5,000,000         ];          // --- State Management ---         let state = {             activeTab: 'income', // 'income', 'deduction', 'dashboard', 'advisor'             isSidebarOpen: window.innerWidth >= 768, // Start open on desktop             incomeInputs: INCOME_TYPES.map(t => ({ id: t.id, amount: 0, actualExpense: 0, useActual: false })),             deductionInputs: DEDUCTION_TYPES.map(t => ({ id: t.id, amount: 0, count: 0 })), // count for child/parent             modalData: {                 isOpen: false,                 title: '',                 content: ''             }         };          // --- Helper Functions ---          /**          * Generates the SVG string for a Lucide icon.          * Note: This is a simplified helper since we cannot use the Lucide React component directly.          * The main icons in the header and sidebar use the data-lucide tag for the Lucide library to handle.          * This function is used for inline icons within dynamic content.          * @param {string} name Icon name (e.g., 'user', 'calculator')          * @param {number} size Size in pixels          * @param {string} classes Additional Tailwind classes          * @returns {string} HTML string for the icon          */         function getIconSvg(name, size = 24, classes = '') {             return `<svg data-lucide="${name}" width="${size}" height="${size}" class="${classes}"></svg>`;         }           /**          * Formats a number with comma separators.          * @param {number} num          * @returns {string}          */         function formatNumber(num) {             return new Intl.NumberFormat('th-TH', { maximumFractionDigits: 0 }).format(num);         }          /**          * Calculates the total tax liability based on net income.          * @param {number} netIncome The income after all deductions and allowances.          * @returns {number} The final tax payable amount.          */         function calculateTax(netIncome) {             if (netIncome <= 0) return 0;              let taxPayable = 0;             let previousMax = 0;              for (const bracket of TAX_BRACKETS) {                 const taxableAmount = Math.max(0, netIncome - previousMax);                                  if (bracket.max === Infinity) {                     taxPayable += taxableAmount * bracket.rate;                     break;                 }                  if (netIncome > bracket.max) {                     // Taxable amount in this bracket (max - previousMax)                     const bracketTaxable = bracket.max - previousMax;                     taxPayable += bracketTaxable * bracket.rate;                 } else {                     // Net income falls within this bracket                     taxPayable += taxableAmount * bracket.rate;                     break;                 }                 previousMax = bracket.max;             }              // ฐานภาษี 150,000 แรกได้รับการยกเว้นภาษี             return Math.max(0, taxPayable);         }           /**          * Core function to perform all tax calculations.          * @returns {object} Calculated tax results.          */         function calculateResults() {             // --- 1. Total Income Calculation ---             let totalIncome = 0;             let income40_1_2 = 0;             const incomeDetails = {};              for (const input of state.incomeInputs) {                 const type = INCOME_TYPES.find(t => t.id === input.id);                 const amount = parseFloat(input.amount) || 0;                                  // Track 40(1) and 40(2) for combined standard deduction                 if (input.id === '40(1)' || input.id === '40(2)') {                     income40_1_2 += amount;                 }                                  totalIncome += amount;                 incomeDetails[input.id] = { amount, type };             }              // --- 2. Standard Expense Deductions (หักค่าใช้จ่าย) ---             let totalDeductibleExpense = 0;             for (const input of state.incomeInputs) {                 const type = INCOME_TYPES.find(t => t.id === input.id);                 const amount = parseFloat(input.amount) || 0;                  let expense = 0;                  if (input.id === '40(1)' || input.id === '40(2)') {                     // These are part of the combined 50% (max 100k) pool. Handled below.                 } else if (input.id === '40(3)') {                     expense = Math.min(100000, amount * 0.5); // 50% max 100k                 } else if (input.id === '40(4)') {                     expense = 0;                 } else if (input.id === '40(5)' || input.id === '40(6)' || input.id === '40(7)' || input.id === '40(8)') {                     // Choose actual vs standard                     const standard = amount * type.defaultRate;                     const actual = parseFloat(input.actualExpense) || 0;                     if (input.useActual && actual > 0) {                         expense = actual;                     } else {                         expense = standard;                     }                 }                 totalDeductibleExpense += expense;             }                          // Add 40(1) + 40(2) combined cap             totalDeductibleExpense += Math.min(100000, income40_1_2 * 0.5);              // Total Income - Total Deductible Expense (This is the Net Income before Allowances)             let netIncomeBeforeAllowances = Math.max(0, totalIncome - totalDeductibleExpense);               // --- 3. Allowances Calculation (ค่าลดหย่อน) ---             let totalAllowanceDeduction = 0;             const allowanceDetails = {};                          // Base allowances from deductionInputs             for (const input of state.deductionInputs) {                 const type = DEDUCTION_TYPES.find(t => t.id === input.id);                 const amount = parseFloat(input.amount) || 0;                 const count = parseFloat(input.count) || 0;                 let deductibleAmount = 0;                  if (input.id === 'personal' || input.id === 'spouse') {                     deductibleAmount = type.max;                 } else if (input.id === 'child') {                     // Simplified: Assume all children get the standard 30k.                     deductibleAmount = count * 30000;                 } else if (input.id === 'parent') {                     deductibleAmount = count * 30000;                 } else if (type.max !== Infinity) {                     deductibleAmount = Math.min(amount, type.max);                 } else if (input.id === 'donation') {                     // Donation is calculated last, capped at 10% of (Net Income - Other Allowances)                     // For now, track the raw amount                     deductibleAmount = amount;                 } else {                     deductibleAmount = amount;                 }                  allowanceDetails[input.id] = { amount, count, deductibleAmount, type };                                  // Sum up non-donation allowances for intermediate calculation                 if (input.id !== 'donation') {                     totalAllowanceDeduction += deductibleAmount;                 }             }                          // Calculate limit for RMF/SSF/PVD (30% of Net Income before other investments)             const netIncomeForInvestmentCap = netIncomeBeforeAllowances - (allowanceDetails['personal']?.deductibleAmount || 0) - (allowanceDetails['spouse']?.deductibleAmount || 0) - (allowanceDetails['child']?.deductibleAmount || 0) - (allowanceDetails['parent']?.deductibleAmount || 0);              // RMF/SSF/PVD combined cap logic:             const pensionInput = state.deductionInputs.find(d => d.id === 'pension_fund');             const pensionAmount = parseFloat(pensionInput?.amount) || 0;             // Cap at 30% of Net Income, and max 500,000             const capRMFSSF = Math.min(500000, netIncomeForInvestmentCap * 0.3);                          // Update pension deduction:             let pensionDeductible = Math.min(pensionAmount, capRMFSSF);                          // Recalculate Total Non-Donation Allowance with corrected pension             totalAllowanceDeduction = 0;             for (const id in allowanceDetails) {                 if (id === 'donation') continue;                 if (id === 'pension_fund') {                     totalAllowanceDeduction += pensionDeductible;                 } else {                     totalAllowanceDeduction += allowanceDetails[id].deductibleAmount;                 }             }               // --- 4. Net Income (เงินได้สุทธิก่อนบริจาค) ---             let netIncome = netIncomeBeforeAllowances - totalAllowanceDeduction;             netIncome = Math.max(0, netIncome);              // --- 5. Donation Deduction (บริจาค) ---             const rawDonation = allowanceDetails['donation']?.amount || 0;             const maxDonationDeductible = netIncome * 0.1;             const finalDonationDeductible = Math.min(rawDonation, maxDonationDeductible);                          // Final Net Income after Donation             let finalNetIncome = netIncome - finalDonationDeductible;             finalNetIncome = Math.max(0, finalNetIncome);              // --- 6. Tax Calculation ---             // Taxable income 150,000 แรกได้รับการยกเว้นภาษี             const taxPayable = calculateTax(finalNetIncome);                          // Calculate Tax Saved: Tax calculated before deductions (minus personal allowance 60k) minus final tax.             // Simplified baseline: Net income before allowances - Personal allowance (60k)             const netIncomeForBaselineTax = netIncomeBeforeAllowances - 60000;             const baseTaxPayable = calculateTax(netIncomeForBaselineTax);              const taxSaved = Math.max(0, baseTaxPayable - taxPayable);               return {                 totalIncome: totalIncome,                 totalExpenseDeduction: totalDeductibleExpense,                 netIncomeBeforeAllowances: netIncomeBeforeAllowances,                 totalAllowanceDeduction: totalAllowanceDeduction + finalDonationDeductible,                 finalNetIncome: finalNetIncome,                 baseTaxPayable: baseTaxPayable,                 taxPayable: taxPayable,                 taxSaved: taxSaved,                 details: {                     income40_1_2,                     pensionDeductible,                     maxDonationDeductible,                     finalDonationDeductible                 }             };         }                  // --- UI & Event Handlers ---          /**          * Toggles the mobile sidebar visibility.          */         function toggleSidebar() {             state.isSidebarOpen = !state.isSidebarOpen;             updateSidebarDisplay();             updateUI(); // Re-render for icon changes if necessary         }                  /**          * Updates the active tab and triggers the main UI refresh.          * @param {string} tabName           */         function setActiveTab(tabName) {             state.activeTab = tabName;             // Close sidebar automatically on mobile after selection             if (window.innerWidth < 768) {                 state.isSidebarOpen = false;                 updateSidebarDisplay();             }             updateUI();             // Scroll to top of main content on tab change             document.querySelector('main').scrollTo({ top: 0, behavior: 'smooth' });         }                  /**          * Handles the click on the 'Next' button.          */         function nextTab() {             const order = ['income', 'deduction', 'dashboard', 'advisor'];             const currentIndex = order.indexOf(state.activeTab);             const next = order[currentIndex + 1];             if (next) {                 setActiveTab(next);             }         }          /**          * Updates the state from an income form input change.          * @param {string} id           * @param {string} field 'amount', 'actualExpense', or 'useActual'          * @param {*} value           */         function handleIncomeChange(id, field, value) {             const index = state.incomeInputs.findIndex(i => i.id === id);             if (index !== -1) {                 if (field === 'useActual') {                     state.incomeInputs[index][field] = value; // Checkbox value is boolean                 } else {                     state.incomeInputs[index][field] = parseFloat(value) || 0;                 }             }             updateUI();         }          /**          * Updates the state from a deduction form input change.          * @param {string} id           * @param {string} field 'amount' or 'count'          * @param {*} value           */         function handleDeductionChange(id, field, value) {             const index = state.deductionInputs.findIndex(i => i.id === id);             if (index !== -1) {                 state.deductionInputs[index][field] = parseFloat(value) || 0;             }             updateUI();         }          /**          * Shows the modal with details.          * @param {string} title           * @param {string} content           */         function showModal(title, content) {             state.modalData = { isOpen: true, title, content };             renderModal();         }          /**          * Hides the modal.          */         function hideModal() {             state.modalData.isOpen = false;             renderModal();         }          // --- Render Functions ---          /**          * Renders the main sidebar navigation.          */         function renderSidebar() {             const tabs = [                 { id: 'income', name: 'รายได้', icon: 'sliders' },                 { id: 'deduction', name: 'ค่าลดหย่อน', icon: 'pie-chart' },                 { id: 'dashboard', name: 'สรุปผล', icon: 'calculator' },                 { id: 'advisor', name: 'Tax Advisor', icon: 'lightbulb' }             ];              const navItems = tabs.map(tab => {                 const isActive = state.activeTab === tab.id;                 return `                     <button                          onclick="setActiveTab('${tab.id}')"                         class="w-full text-left flex items-center gap-3 p-3 rounded-xl transition-colors ${isActive ? 'bg-blue-50 text-blue-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'}"                     >                         ${getIconSvg(tab.icon, 20)}                         <span class="text-sm">${tab.name}</span>                     </button>                 `;             }).join('');              const sidebarHtml = `                 <div class="flex flex-col h-full">                     <div class="flex justify-between items-center mb-6 md:mb-8">                         <h2 class="text-2xl font-extrabold text-blue-600 flex items-center gap-2">                              ${getIconSvg('calculator', 24)}                             Tax Flow                         </h2>                         <button class="md:hidden p-1 rounded-full text-gray-500 hover:bg-gray-100" onclick="toggleSidebar()">                             ${getIconSvg('x', 24)}                         </button>                     </div>                     <nav class="space-y-2 flex-grow">                         ${navItems}                     </nav>                     <div class="pt-4 border-t border-gray-100 mt-4">                         <div class="p-3 bg-gray-50 rounded-xl">                             <p class="text-xs font-medium text-gray-500">ข้อมูลอ้างอิง</p>                             <p class="text-xs text-gray-400">อัปเดตล่าสุด: ปีภาษี 2567</p>                         </div>                     </div>                 </div>             `;             document.getElementById('sidebar').innerHTML = sidebarHtml;         }          /**          * Renders the Income input page.          */         function renderIncomePage() {             const formInputs = state.incomeInputs.map(input => {                 const type = INCOME_TYPES.find(t => t.id === input.id);                 // 40(1), 40(2), 40(3) has a fixed standard deduction cap.                 // 40(5) to 40(8) can choose between standard rate or actual expense.                 const canUseActual = input.id !== '40(1)' && input.id !== '40(2)' && input.id !== '40(3)' && input.id !== '40(4)' && type.defaultRate > 0;                                  return `                     <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100">                         <div class="flex justify-between items-start mb-3">                             <h3 class="text-lg font-bold text-gray-800">${type.name}</h3>                             <button onclick="showModal('${type.name}', 'ประเภทเงินได้: ${type.desc}<br><br><strong>หักค่าใช้จ่าย:</strong> ${type.deductionDesc}')" class="text-blue-500 hover:text-blue-700 transition-colors">                                 ${getIconSvg('info', 20, 'inline-block')}                             </button>                         </div>                         <p class="text-sm text-gray-500 mb-4">${type.desc}</p>                                                  <label for="income-${type.id}" class="block text-sm font-medium text-gray-700 mb-1">จำนวนเงินได้ (บาท)</label>                         <input                             type="number"                             id="income-${type.id}"                             value="${input.amount || ''}"                             onchange="handleIncomeChange('${type.id}', 'amount', this.value)"                             placeholder="เช่น 300000"                             class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-shadow"                             min="0"                         />                          ${canUseActual ? `                             <div class="mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">                                 <div class="flex items-center mb-2">                                     <input                                          type="checkbox"                                          id="useActual-${type.id}"                                          ${input.useActual ? 'checked' : ''}                                         onchange="handleIncomeChange('${type.id}', 'useActual', this.checked)"                                         class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"                                     />                                     <label for="useActual-${type.id}" class="ml-2 text-sm font-medium text-yellow-800">เลือกหักค่าใช้จ่ายตามจริง</label>                                 </div>                                  <input                                     type="number"                                     id="actualExpense-${type.id}"                                     value="${input.actualExpense || ''}"                                     onchange="handleIncomeChange('${type.id}', 'actualExpense', this.value)"                                     placeholder="ค่าใช้จ่ายตามจริง (ถ้าเลือก)"                                     class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-shadow mt-2 ${input.useActual ? '' : 'hidden'}"                                     min="0"                                     ${input.useActual ? '' : 'disabled'}                                 />                             </div>                         ` : ''}                      </div>                 `;             }).join('');              return `                 <h2 class="text-3xl font-extrabold text-gray-900 mb-6">1. ข้อมูลรายได้</h2>                 <p class="text-gray-600 mb-8">กรุณากรอกรายได้ต่อปีของท่านตามประเภทเงินได้มาตรา 40</p>                 <div class="space-y-6">                     ${formInputs}                 </div>             `;         }                  /**          * Renders the Deduction input page.          */         function renderDeductionPage() {             const sections = {                 family: { name: 'ส่วนตัวและครอบครัว', icon: 'users', items: [] },                 insurance: { name: 'ประกันและกองทุน', icon: 'heart-pulse', items: [] },                 investment: { name: 'การลงทุนระยะยาว', icon: 'trending-up', items: [] },                 property: { name: 'ที่อยู่อาศัย', icon: 'home', items: [] },                 other: { name: 'อื่นๆ (เช่น บริจาค)', icon: 'gift', items: [] },             };              state.deductionInputs.forEach(input => {                 const type = DEDUCTION_TYPES.find(t => t.id === input.id);                 if (sections[type.type]) {                     sections[type.type].items.push({ input, type });                 }             });              const renderSection = (section) => {                 const itemsHtml = section.items.map(({ input, type }) => {                     const isCountBased = input.id === 'child' || input.id === 'parent';                     const inputField = isCountBased ? 'count' : 'amount';                     const placeholder = isCountBased ? 'จำนวนคน' : 'จำนวนเงินที่จ่ายจริง';                      let inputType = 'number';                     if (input.id === 'donation') {                         inputType = 'number';                      }                      return `                         <div class="border border-gray-200 p-4 rounded-xl flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 bg-gray-50">                             <div class="flex-1">                                 <div class="text-sm font-semibold text-gray-700 flex items-center gap-2">                                     ${getIconSvg(type.icon, 18)}                                     ${type.name}                                 </div>                                 <p class="text-xs text-gray-500 mt-1">${type.desc}</p>                             </div>                             <div class="w-full sm:w-1/3 min-w-[150px]">                                 <input                                     type="${inputType}"                                     value="${input[inputField] || ''}"                                     onchange="handleDeductionChange('${type.id}', '${inputField}', this.value)"                                     placeholder="${placeholder}"                                     class="w-full p-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500"                                     min="0"                                 />                             </div>                         </div>                     `;                 }).join('');                  return `                     <div class="mt-8">                         <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2 mb-4 p-2 rounded-lg bg-blue-50 border-l-4 border-blue-600">                              ${getIconSvg(section.icon, 22, 'text-blue-600')}                             ${section.name}                         </h3>                         <div class="space-y-3">                             ${itemsHtml}                         </div>                     </div>                 `;             };               return `                 <h2 class="text-3xl font-extrabold text-gray-900 mb-6">2. ข้อมูลค่าลดหย่อน</h2>                 <p class="text-gray-600 mb-8">กรุณากรอกจำนวนเงิน/จำนวนคน สำหรับสิทธิ์ค่าลดหย่อนที่ท่านมี</p>                 <div class="space-y-6">                     ${renderSection(sections.family)}                     ${renderSection(sections.insurance)}                     ${renderSection(sections.investment)}                     ${renderSection(sections.property)}                     ${renderSection(sections.other)}                 </div>                 <div class="mt-8 p-4 bg-red-50 border border-red-200 rounded-xl">                     <p class="text-sm font-medium text-red-700">ข้อควรระวัง: ระบบนี้เป็นเพียงการจำลองเพื่อการวางแผนเท่านั้น! เงื่อนไขลดหย่อนจริงมีความซับซ้อน ควรปรึกษาผู้เชี่ยวชาญก่อนยื่นภาษีจริง</p>                 </div>             `;         }          /**          * Renders the Dashboard/Summary page.          */         function renderDashboard() {             const results = calculateResults();             const taxPayable = results.taxPayable;             const taxSaved = results.taxSaved;             const taxRate = results.finalNetIncome > 0 ? (taxPayable / results.finalNetIncome) * 100 : 0;             const netIncome = results.finalNetIncome;                          const statusClass = taxPayable > 0 ? 'bg-red-500' : 'bg-green-600';             const statusText = taxPayable > 0 ? 'ต้องชำระเพิ่ม' : 'ไม่ต้องชำระ';              const dataPoints = [                 { name: 'เงินได้รวมทั้งสิ้น', value: results.totalIncome, icon: 'coins' },                 { name: 'หักค่าใช้จ่าย', value: results.totalExpenseDeduction, icon: 'sliders' },                 { name: 'เงินได้หลังหักค่าใช้จ่าย', value: results.netIncomeBeforeAllowances, icon: 'trending-up' },                 { name: 'หักค่าลดหย่อนทั้งหมด', value: results.totalAllowanceDeduction, icon: 'umbrella' },                 { name: 'เงินได้สุทธิ (Net Income)', value: netIncome, icon: 'check-circle' },             ];              const summaryHtml = dataPoints.map(item => `                 <div class="flex justify-between items-center py-3 border-b last:border-b-0">                     <div class="text-gray-600 flex items-center gap-2 font-medium">                         ${getIconSvg(item.icon, 18, 'text-blue-500')}                         ${item.name}                     </div>                     <div class="text-lg font-semibold text-gray-900">                         ${formatNumber(item.value)} บาท                     </div>                 </div>             `).join('');               return `                 <h2 class="text-3xl font-extrabold text-gray-900 mb-6">3. สรุปผลการคำนวณภาษี</h2>                 <p class="text-gray-600 mb-8">ผลการคำนวณจำลองจากข้อมูลรายได้และค่าลดหย่อนที่ท่านกรอก</p>                  <!-- Tax Payable Card -->                 <div class="p-8 rounded-2xl shadow-2xl ${statusClass} text-white mb-8 transform transition-all duration-300 hover:scale-[1.01] flex flex-col justify-center items-center text-center">                     <p class="text-3xl font-bold mb-2">ภาษีที่ต้องชำระ / คืน</p>                     <p class="text-6xl font-extrabold mb-4">                         ${formatNumber(Math.abs(taxPayable))}                     </p>                     <p class="text-xl font-medium">${statusText}</p>                     ${taxSaved > 0 ? `                         <div class="mt-4 p-2 bg-white/20 rounded-lg text-sm font-semibold">                             <p>💰 ลดภาษีจากค่าลดหย่อนได้รวม: ${formatNumber(taxSaved)} บาท</p>                         </div>                     ` : ''}                 </div>                  <!-- Calculation Breakdown -->                 <div class="bg-white p-6 rounded-xl shadow-lg mb-8">                     <h3 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">รายละเอียดการคำนวณ</h3>                     ${summaryHtml}                 </div>                  <!-- Tax Rate Info -->                 <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">                     <h3 class="text-xl font-bold text-blue-700 mb-3">อัตราภาษีที่ท่านต้องจ่าย</h3>                     <p class="text-4xl font-extrabold text-blue-600 mb-3">                         ${taxRate.toFixed(2)}%                     </p>                     <p class="text-gray-700">เงินได้สุทธิ ${formatNumber(netIncome)} บาท อยู่ในฐานภาษีสูงสุดที่ ${TAX_BRACKETS.find(b => netIncome <= b.max) ? (TAX_BRACKETS.find(b => netIncome <= b.max).rate * 100).toFixed(0) : '35'}%</p>                 </div>             `;         }          /**          * Renders the (simplified) Tax Advisor page.          */         function renderAdvisor() {             const results = calculateResults();             const taxPayable = results.taxPayable;             const taxSaved = results.taxSaved;                          // Simplified LLM response simulation             const taxBracketRate = TAX_BRACKETS.find(b => results.finalNetIncome <= b.max) ? (TAX_BRACKETS.find(b => results.finalNetIncome <= b.max).rate * 100).toFixed(0) : '35';              const advice = `                 <div class="space-y-4">                     <p>สวัสดีครับ! ผมคือผู้ช่วยวางแผนภาษี AI ของคุณ จากข้อมูลที่ท่านกรอกเข้ามา ผมได้วิเคราะห์สถานการณ์ภาษีของท่านดังนี้:</p>                                          <div class="p-4 bg-green-50 rounded-xl border border-green-200">                         <h4 class="font-bold text-lg text-green-700 flex items-center gap-2">                             ${getIconSvg('activity', 20)}                             สรุปสถานะภาษี                         </h4>                         <ul class="list-disc list-inside ml-4 text-gray-700">                             <li>เงินได้สุทธิ: <strong class="text-green-800">${formatNumber(results.finalNetIncome)} บาท</strong></li>                             <li>ภาษีที่ต้องชำระ: <strong class="text-red-700">${formatNumber(taxPayable)} บาท</strong></li>                             <li>มูลค่าการลดหย่อนทั้งหมด: <strong class="text-blue-700">${formatNumber(results.totalAllowanceDeduction)} บาท</strong></li>                             <li>ท่านประหยัดภาษีได้: <strong class="text-blue-700">${formatNumber(taxSaved)} บาท</strong></li>                         </ul>                     </div>                      <div class="p-4 bg-yellow-50 rounded-xl border border-yellow-200">                         <h4 class="font-bold text-lg text-yellow-800 flex items-center gap-2">                             ${getIconSvg('lightbulb', 20)}                             คำแนะนำเบื้องต้นเพื่อประหยัดภาษีเพิ่ม                         </h4>                         <p class="text-gray-700 mt-2">                            เนื่องจากเงินได้สุทธิของท่านอยู่ในฐานภาษี ${taxBracketRate}% การลดหย่อนทุก 1 บาท จะช่วยลดภาษีได้ ${taxBracketRate} สตางค์                         </p>                         <ul class="list-disc list-inside ml-4 mt-2 text-gray-700">                             <li><strong class="font-semibold">การลงทุน:</strong> หากท่านยังไม่ได้ลงทุนใน RMF/SSF จนเต็มเพดาน 30% หรือ 500,000 บาท ท่านควรพิจารณาเพื่อลดภาระภาษีในปัจจุบันและเพิ่มความมั่งคั่งในระยะยาว</li>                             <li><strong class="font-semibold">ประกัน:</strong> หากท่านมีวงเงินประกันสุขภาพที่ยังไม่เต็ม 25,000 บาท การซื้อเพิ่มสามารถนำมาลดหย่อนได้อีก</li>                             <li><strong class="font-semibold">การบริจาค:</strong> การบริจาคสามารถลดหย่อนได้สูงสุด 10% ของเงินได้หลังหักค่าใช้จ่ายและค่าลดหย่อนอื่นๆ หากท่านยังไม่ถึงเพดาน การบริจาคเพิ่มเป็นทางเลือกที่ดี</li>                         </ul>                     </div>                 </div>             `;               return `                 <h2 class="text-3xl font-extrabold text-gray-900 mb-6">4. Tax Advisor AI</h2>                 <p class="text-gray-600 mb-8">ให้ AI ช่วยวิเคราะห์สถานการณ์ภาษีและเสนอแนะแนวทางการวางแผนภาษีเบื้องต้น</p>                                  <div class="p-6 bg-white rounded-xl shadow-lg border border-blue-100">                     <h3 class="text-2xl font-bold text-blue-700 mb-4 flex items-center gap-2">                         ${getIconSvg('lightbulb', 24)}                         รายงานการวิเคราะห์จาก AI                     </h3>                     ${advice}                 </div>             `;         }          /**          * Renders the generic Card for a page.          * @param {string} contentHtml          * @returns {string}          */         function renderPageContent(contentHtml) {             return `                 <div class="bg-white p-6 md:p-10 rounded-xl shadow-xl">                     ${contentHtml}                 </div>             `;         }                  /**          * Renders the Modal component.          */         function renderModal() {             const modalContainer = document.getElementById('modal-container');             if (!state.modalData.isOpen) {                 modalContainer.innerHTML = '';                 document.body.classList.remove('overflow-hidden');                 return;             }              document.body.classList.add('overflow-hidden');              modalContainer.innerHTML = `                 <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 transition-opacity duration-300">                     <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full transform scale-100 transition-transform duration-300 overflow-hidden">                         <!-- Modal Header -->                         <div class="p-5 border-b border-gray-200 flex justify-between items-center bg-blue-600 text-white">                             <h3 class="text-xl font-bold">${state.modalData.title}</h3>                             <button onclick="hideModal()" class="text-white hover:text-gray-200 transition-colors p-1 rounded-full hover:bg-white/10">                                 ${getIconSvg('x', 24)}                             </button>                         </div>                                                  <!-- Modal Body -->                         <div class="p-5 text-gray-700 max-h-[70vh] overflow-y-auto">                             ${state.modalData.content}                         </div>                                                  <!-- Modal Footer -->                         <div class="p-4 border-t border-gray-200 flex justify-end">                             <button onclick="hideModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium transition-colors">ปิด</button>                         </div>                     </div>                 </div>             `;         }           /**          * The main render loop that updates all dynamic parts of the UI.          */         function updateUI() {             // 1. Render Sidebar             renderSidebar();              // 2. Render Page Content             const pageContentEl = document.getElementById('page-content');             let content = '';              switch (state.activeTab) {                 case 'income':                     content = renderIncomePage();                     break;                 case 'deduction':                     content = renderDeductionPage();                     break;                 case 'dashboard':                     content = renderDashboard();                     break;                 case 'advisor':                     content = renderAdvisor();                     break;             }             pageContentEl.innerHTML = renderPageContent(content);                          // 3. Render Modal             renderModal();              // 4. Update Next Button visibility             const nextButtonContainer = document.getElementById('next-button-container');             if (state.activeTab !== 'advisor' && state.activeTab !== 'dashboard') {                 nextButtonContainer.classList.remove('hidden');             } else {                 nextButtonContainer.classList.add('hidden');             }                          // 5. Lucide Icon Replacement (Crucial step for icons to work)             // Re-render icons on the entire page or a specific container             if (typeof lucide !== 'undefined' && lucide.createIcons) {                  lucide.createIcons();             }                          // 6. Update sidebar state on resize/init (handles responsiveness)             updateSidebarDisplay();         }                  /**          * Adjusts sidebar state based on screen size (for responsiveness).          */         function updateSidebarDisplay() {              const sidebar = document.getElementById('sidebar');              const backdrop = document.getElementById('sidebar-backdrop');              const main = document.querySelector('.flex-1');               if (window.innerWidth >= 768) {                  // Desktop view: always show sidebar                  sidebar.classList.remove('-translate-x-full');                  main.classList.add('md:ml-64');                  backdrop.classList.add('hidden');                  state.isSidebarOpen = true;              } else {                  // Mobile view: control based on state                  main.classList.remove('md:ml-64');                  if (state.isSidebarOpen) {                      sidebar.classList.remove('-translate-x-full');                      backdrop.classList.remove('hidden', 'opacity-0');                      backdrop.classList.add('opacity-50');                  } else {                      sidebar.classList.add('-translate-x-full');                      backdrop.classList.add('hidden', 'opacity-0');                      backdrop.classList.remove('opacity-50');                  }              }         }                   // --- Initialization ---          // Wait for the window to fully load before running the app         window.onload = function() {             // Initialize event listener for screen resize             window.addEventListener('resize', updateSidebarDisplay);                          // Initial render             updateUI();         };      </script> </body> </html> 
